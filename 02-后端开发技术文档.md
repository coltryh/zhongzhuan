# 拜耳智能招采平台 - 后端开发技术文档

> 本文档详细讲解项目的后端技术架构、业务实现、代码设计和开发规范。

---

## 目录

- [一、项目概述](#一项目概述)
- [二、后端技术栈详解](#二后端技术栈详解)
- [三、项目架构设计](#三项目架构设计)
- [四、核心业务实现](#四核心业务实现)
- [五、技术实现细节](#五技术实现细节)
- [六、数据库设计](#六数据库设计)
- [七、开发规范与最佳实践](#七开发规范与最佳实践)
- [八、常见问题与解决方案](#八常见问题与解决方案)

---

## 一、项目概述

### 1.1 项目信息

- **项目名称**：拜耳中国-华东区招标采购流程管理系统
- **项目类型**：企业级B2B业务管理系统
- **业务领域**：医药行业招标采购
- **开发语言**：Java 17
- **核心框架**：Spring Boot 3.5.7

### 1.2 系统特点

✅ **前后端分离**：RESTful API 设计
✅ **安全可靠**：JWT + OAuth2 双重认证
✅ **高性能**：异步任务 + 线程池优化
✅ **易维护**：清晰的分层架构
✅ **可扩展**：模块化设计

---

## 二、后端技术栈详解

### 2.1 核心框架

#### Spring Boot 3.5.7

**为什么选择 Spring Boot 3？**

1. **最新特性**：
   - 支持 Java 17
   - Jakarta EE（javax.* → jakarta.*）
   - 原生支持 GraalVM

2. **性能提升**：
   - 启动速度提升 30%
   - 内存占用降低 20%
   - 更优化的响应处理

3. **生态完善**：
   - Spring Security 6
   - Spring Data JPA
   - 丰富的 Starter 依赖

**项目启动类**：
```java
@SpringBootApplication(
    scanBasePackages = "com.bayer.bidding"
)
@MapperScan(basePackages = {"com.bayer.bidding.mapper"})
@EnableConfigurationProperties
@EnableScheduling         // 启用定时任务
@EnableAsync             // 启用异步任务
public class BiddingApplication {
    public static void main(String[] args) {
        SpringApplication.run(BiddingApplication.class, args);
    }
}
```

**关键注解说明**：
- `@SpringBootApplication`：Spring Boot 核心注解
- `@MapperScan`：扫描 MyBatis Mapper 接口
- `@EnableScheduling`：启用定时任务
- `@EnableAsync`：启用异步方法

### 2.2 数据访问层

#### MyBatis Plus 3.5.14

**MyBatis Plus vs MyBatis**：

| 特性 | MyBatis | MyBatis Plus |
|------|---------|--------------|
| CRUD | 手动编写 | 自动提供 |
| 分页 | 手动编写 | 内置分页 |
| 条件构造 | 手动编写 SQL | Lambda 表达式 |
| 代码生成 | 需要插件 | 内置生成器 |

**配置示例**：
```yaml
mybatis-plus:
  mapper-locations: classpath:/mapper/*Mapper.xml
  type-aliases-package: com.bayer.bidding.entity
  configuration:
    map-underscore-to-camel-case: true  # 驼峰命名转换
  global-config:
    db-config:
      id-type: auto          # 主键自增
      logic-delete-field: deleted
      logic-delete-value: 0  # 逻辑删除值
      logic-not-delete-value: 1
```

**Mapper 接口**：
```java
public interface BiddingProductMapper
    extends BaseMapper<BiddingProductDO> {

    // 继承 BaseMapper 后自动获得以下方法：
    // - insert(T entity)
    // - deleteById(Serializable id)
    // - updateById(T entity)
    // - selectById(Serializable id)
    // - selectList(Wrapper<T> wrapper)
    // - selectPage(Page<T> page, Wrapper<T> wrapper)

    // 自定义查询方法
    ProductsVO getProductByDrugCode(@Param("drugCode") String drugCode);

    Page<ProductsVO> pageProducts(
        Page<ProductsVO> page,
        @Param("req") ProductDTO req
    );
}
```

**Lambda 查询**：
```java
// 查询医保药品代码为 "XXX" 的产品
LambdaQueryWrapper<BiddingProductDO> wrapper = new LambdaQueryWrapper<BiddingProductDO>()
    .eq(BiddingProductDO::getDrugCode, "XXX")
    .eq(BiddingProductDO::getDeleted, false);

BiddingProductDO product = biddingProductMapper.selectOne(wrapper);

// 模糊查询
LambdaQueryWrapper<BiddingProductDO> wrapper = new LambdaQueryWrapper<BiddingProductDO>()
    .like(BiddingProductDO::getProductName, "阿司匹林")
    .orderByDesc(BiddingProductDO::getCreateDate);

List<BiddingProductDO> list = biddingProductMapper.selectList(wrapper);
```

### 2.3 安全框架

#### Spring Security + JWT

**认证架构**：
```
用户登录
  ↓
验证用户名密码
  ↓
生成 JWT Token
  ↓
返回 Token 给前端
  ↓
前端每次请求携带 Token
  ↓
后端验证 Token
  ↓
允许访问资源
```

**JWT 工具类**：
```java
@Component
public class JwtUtil {

    @Value("${jwt.secret}")
    private String secretKey;

    private static final long EXPIRATION_TIME = 86400000;  // 24小时

    // 生成 Token
    public String generateToken(AuthUserInfo userInfo) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userInfo.getUserId());
        claims.put("username", userInfo.getUsername());
        claims.put("email", userInfo.getEmail());
        claims.put("roles", userInfo.getRoles());

        return Jwts.builder()
            .setClaims(claims)
            .setSubject(userInfo.getUsername())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
            .signWith(SignatureAlgorithm.HS256, secretKey)
            .compact();
    }

    // 解析 Token
    public AuthUserInfo parseToken(String token) {
        Claims claims = Jwts.parserBuilder()
            .setSigningKey(secretKey)
            .build()
            .parseClaimsJws(token)
            .getBody();

        AuthUserInfo userInfo = new AuthUserInfo();
        userInfo.setUserId(claims.get("userId", Long.class));
        userInfo.setUsername(claims.get("username", String.class));
        userInfo.setEmail(claims.get("email", String.class));
        userInfo.setRoles(claims.get("roles", List.class));

        return userInfo;
    }

    // 验证 Token
    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder()
                .setSigningKey(secretKey)
                .build()
                .parseClaimsJws(token);
            return true;
        } catch (JwtException e) {
            return false;
        }
    }
}
```

**OAuth2 集成（Azure AD）**：

**配置文件**：
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          bidding-client:
            provider: bidding-provider
            client-id: fca87455-cda4-4e2d-a9d8-8bca8296c002
            client-secret: hy58Q~bvtqWoTNrHkGm8TyVZ~vOqNPKO7ikL1aW1
            authorization-grant-type: authorization_code
            redirect-uri: http://localhost:9900/bidding/login/oauth2/code/bidding-client
            scope: openid, profile, email
        provider:
          bidding-provider:
            issuer-uri: https://login.microsoftonline.com/5d825b24-dadf-46ac-9ce9-18dd04cb9b71/v2.0
```

**SSO 登录处理**：
```java
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .oauth2Login(oauth2 -> oauth2
                .successHandler((request, response, authentication) -> {
                    OidcUser oidcUser = (OidcUser) authentication.getPrincipal();

                    // 1. 从 Azure AD 获取用户信息
                    List<String> roles = oidcUser.getClaim("roles");
                    String cwid = oidcUser.getAttribute("https://bayer.com/cwid");

                    // 2. SSO 登录处理
                    AuthUserInfo userInfo = userLoginService.ssoLogin(
                        oidcUser.getEmail(),
                        cwid,
                        roles
                    );

                    // 3. 重定向到前端并携带 token
                    response.sendRedirect(
                        frontendBaseUrl + "/login?token=" + userInfo.getToken()
                    );
                })
            );

        return http.build();
    }
}
```

### 2.4 API 文档

#### SpringDoc OpenAPI 2.8.14

**配置**：
```java
@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
            .info(new Info()
                .title("拜耳智能招采平台 API")
                .version("1.0")
                .description("招标采购流程管理系统接口文档"))
            .addSecurityItem(new SecurityRequirement()
                .addList("Authorization"))
            .components(new Components()
                .addSecuritySchemes("Authorization",
                    new SecurityScheme()
                        .type(SecurityScheme.Type.HTTP)
                        .scheme("bearer")
                        .bearerFormat("JWT")));
    }
}
```

**使用注解**：
```java
@RestController
@RequestMapping("/biddingProjects")
@Tag(name = "项目管理", description = "项目相关接口")
public class BiddingProjectsController {

    @Operation(summary = "获取项目列表", description = "分页查询项目列表")
    @Parameter(name = "pageNumber", description = "页码", required = true)
    @Parameter(name = "pageSize", description = "每页大小", required = true)
    @PostMapping("/pageBiddingProjects")
    public Result<Page<ProjectVO>> pageBiddingProjects(
        @RequestBody @Validated ProjectListDTO dto) {
        // ...
    }
}
```

**访问文档**：
```
开发环境：http://localhost:9900/bidding/swagger-ui.html
生产环境：http://your-domain/bidding/swagger-ui.html
```

### 2.5 工具库

#### Hutool 5.8.42

**常用工具**：
```java
// 1. 日期时间
DateUtil.today()                    // 今天
DateUtil.yesterday()                // 昨天
DateUtil tomorrow()                 // 明天
DateUtil.format(date, "yyyy-MM-dd") // 格式化
DateUtil.parse("2024-01-01")        // 解析

// 2. 字符串
StrUtil.isBlank("")                 // 是否为空
StrUtil.isNotEmpty("abc")           // 是否不为空
StrUtil.upperFirst("abc")           // 首字母大写

// 3. 集合
CollUtil.newArrayList()            // 创建 ArrayList
CollUtil.union(list1, list2)        // 并集
CollUtil.intersection(list1, list2)// 交集

// 4. 对象
ObjectUtil.isEmpty(obj)             // 是否为空
ObjectUtil.equal(obj1, obj2)        // 是否相等
BeanUtil.copyProperties(source, target) // 对象拷贝

// 5. 加密
SecureUtil.md5("123456")            // MD5
SecureUtil.sha256("123456")         // SHA256
SecureUtil.des(key, data)           // DES 加密

// 6. 随机数
RandomUtil.randomString(6)          // 随机字符串
RandomUtil.randomInt(0, 100)        // 随机整数
RandomUtil.randomNumbers(6)         // 随机数字

// 7. 身份证
IdcardUtil.isValidCard(idCard)      // 验证身份证
IdcardUtil.getBirthByIdCard(idCard)// 获取生日

// 8. 手机号
PhoneUtil.isMobile(phone)           // 是否手机号
PhoneUtil.hideBefore(phone, 3)     // 隐藏前3位
```

#### FastJSON 2.0.60

**JSON 处理**：
```java
// 1. 对象转 JSON
String json = JSON.toJSONString(user);

// 2. JSON 转对象
User user = JSON.parseObject(json, User.class);

// 3. JSON 转列表
List<User> list = JSON.parseArray(json, User.class);

// 4. JSON 转 Map
Map<String, Object> map = JSON.parseObject(json, new TypeReference<Map<String, Object>>(){});

// 5. 格式化输出
String prettyJson = JSON.toJSONString(user, JSONWriter.Feature.PrettyFormat);
```

#### EasyExcel 3.1.1

**Excel 导入**：
```java
// 1. 定义实体
@Data
public class PriceImportDTO {
    @ExcelProperty("省份")
    private String province;

    @ExcelProperty("医保药品代码")
    private String drugCode;

    @ExcelProperty("挂网价")
    private BigDecimal nettingPrice;

    @ExcelProperty("执行时间")
    private String executionDate;
}

// 2. 监听器
public class PriceImportListener extends AnalysisEventListener<PriceImportDTO> {

    private List<PriceImportDTO> list = new ArrayList<>();

    @Override
    public void invoke(PriceImportDTO data, AnalysisContext context) {
        list.add(data);

        // 批量处理（每1000条）
        if (list.size() >= 1000) {
            saveData();
            list.clear();
        }
    }

    @Override
    public void doAfterAllAnalysed(AnalysisContext context) {
        // 处理剩余数据
        saveData();
    }

    private void saveData() {
        // 保存到数据库
        biddingPriceService.batchInsert(list);
    }
}

// 3. 导入方法
public void importPrices(MultipartFile file) throws IOException {
    EasyExcel.read(file.getInputStream(), PriceImportDTO.class, new PriceImportListener())
        .sheet()
        .doRead();
}
```

**Excel 导出**：
```java
public void exportPrices(HttpServletResponse response) throws IOException {
    // 1. 查询数据
    List<PriceExportVO> list = getPriceData();

    // 2. 设置响应头
    response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    response.setCharacterEncoding("utf-8");
    String fileName = URLEncoder.encode("价格数据", StandardCharsets.UTF_8);
    response.setHeader("Content-disposition", "attachment;filename*=utf-8''" + fileName + ".xlsx");

    // 3. 写入 Excel
    EasyExcel.write(response.getOutputStream(), PriceExportVO.class)
        .sheet("价格数据")
        .doWrite(list);
}
```

### 2.6 文件存储

#### AWS S3 SDK 2.25.23

**配置**：
```yaml
aws:
  s3:
    endpoint: https://s3.amazonaws.com
    region: us-east-1
    access-key-id: YOUR_ACCESS_KEY
    secret-access-key: YOUR_SECRET_KEY
    bucket-name: bidding-files
```

**上传文件**：
```java
@Service
public class AwsS3ServiceImpl implements AwsS3Service {

    @Autowired
    private S3Client s3Client;

    @Value("${aws.s3.bucket-name}")
    private String bucketName;

    @Override
    public String uploadFile(MultipartFile file, Long userId) throws IOException {
        // 1. 生成文件编号
        String fileNumber = "FILE-" + System.currentTimeMillis();

        // 2. 构建 S3 对象键
        String originalFilename = file.getOriginalFilename();
        String extension = originalFilename.substring(originalFilename.lastIndexOf("."));
        String fileKey = "documents/" + LocalDate.now() + "/" + fileNumber + extension;

        // 3. 上传到 S3
        PutObjectRequest putObjectRequest = PutObjectRequest.builder()
            .bucket(bucketName)
            .key(fileKey)
            .contentLength(file.getSize())
            .contentType(file.getContentType())
            .build();

        s3Client.putObject(
            putObjectRequest,
            RequestBody.fromBytes(file.getBytes())
        );

        // 4. 记录文件信息
        BiddingFileInfoDO fileInfo = new BiddingFileInfoDO();
        fileInfo.setFileNumber(fileNumber);
        fileInfo.setFileName(originalFilename);
        fileInfo.setFilePath("s3://" + bucketName + "/" + fileKey);
        fileInfo.setCreateBy(userId);
        fileInfo.setCreateDate(LocalDateTime.now());

        fileInfoMapper.insert(fileInfo);

        return fileNumber;
    }
}
```

**下载文件**：
```java
@Override
public byte[] downloadFile(String fileNumber) {
    // 1. 查询文件信息
    BiddingFileInfoDO fileInfo = fileInfoMapper.selectOne(
        new LambdaQueryWrapper<BiddingFileInfoDO>()
            .eq(BiddingFileInfoDO::getFileNumber, fileNumber)
    );

    if (fileInfo == null) {
        throw new BusinessException("文件不存在");
    }

    // 2. 从 S3 下载
    String fileKey = fileInfo.getFilePath().replace("s3://" + bucketName + "/", "");

    GetObjectRequest getObjectRequest = GetObjectRequest.builder()
        .bucket(bucketName)
        .key(fileKey)
        .build();

    ResponseBytes<GetObjectResponse> object = s3Client.getObjectAsBytes(getObjectRequest);

    return object.asByteArray();
}
```

---

## 三、项目架构设计

### 3.1 分层架构

```
┌─────────────────────────────────────┐
│      Controller 层（表现层）         │  ← 处理 HTTP 请求/响应
├─────────────────────────────────────┤
│      Service 层（业务逻辑层）        │  ← 核心业务逻辑
├─────────────────────────────────────┤
│      Mapper 层（数据访问层）         │  ← 数据库 CRUD
├─────────────────────────────────────┤
│      Database（数据持久层）          │  ← MySQL 数据库
└─────────────────────────────────────┘
```

#### Controller 层（表现层）

**职责**：
- 接收 HTTP 请求
- 参数校验（@Validated）
- 调用 Service 层
- 返回统一响应

**示例**：
```java
@RestController
@RequestMapping("/product")
@Tag(name = "产品管理")
public class BiddingProductController extends BaseController {

    @Autowired
    private IBiddingProductService biddingProductService;

    @Operation(summary = "创建产品")
    @PostMapping("/createProduct")
    public Result<String> createProduct(
        HttpServletRequest request,
        @RequestBody @Validated ProductDTO req) {

        // 1. 获取当前用户信息
        AuthUserInfo userInfo = getUserInfoByToken(request);

        // 2. 调用 Service 层
        String result = biddingProductService.createProduct(req, userInfo);

        // 3. 返回统一响应
        return Result.success(result);
    }
}
```

**设计原则**：
1. **薄 Controller**：Controller 只负责接收请求和返回响应
2. **统一认证**：继承 BaseController 获取用户信息
3. **参数校验**：使用 @Validated 进行 Bean Validation

#### Service 层（业务逻辑层）

**职责**：
- 核心业务逻辑处理
- 事务管理（@Transactional）
- 数据组装与转换
- 调用 Mapper 层

**示例**：
```java
@Service
@Slf4j
public class BiddingProductServiceImpl
    extends ServiceImpl<BiddingProductMapper, BiddingProductDO>
    implements IBiddingProductService {

    @Autowired
    private BiddingProductMapper biddingProductMapper;

    @Override
    @OperationLog(
        beforeMethod = "snapshotBeforeSave(#req?.drugCode)",
        afterMethod = "snapshotAfterSave(#req?.drugCode)",
        userId = "#userInfo?.userId"
    )
    @Transactional(rollbackFor = Exception.class)
    public String createProduct(ProductDTO req, AuthUserInfo userInfo) {
        // 1. 业务校验
        ProductsVO existProduct = biddingProductMapper.getProductByDrugCode(
            req.getDrugCode()
        );
        if (existProduct != null) {
            throw new BusinessException("产品库中存在当前医保产品代码");
        }

        // 2. 构建实体对象
        BiddingProductDO productDO = new BiddingProductDO();
        BeanUtils.copyProperties(req, productDO);
        productDO.setCreateDate(LocalDateTime.now());
        productDO.setCreateBy(userInfo.getUserId());

        // 3. 保存到数据库
        biddingProductMapper.insert(productDO);

        // 4. 返回结果
        return "新增产品成功";
    }
}
```

**设计原则**：
1. **单一职责**：每个方法只做一件事
2. **事务控制**：在 Service 层添加 @Transactional
3. **异常处理**：使用统一的 BusinessException

#### Mapper 层（数据访问层）

**职责**：
- 数据库 CRUD 操作
- 复杂查询
- 继承 MyBatis Plus BaseMapper

**示例**：
```java
public interface BiddingProductMapper extends BaseMapper<BiddingProductDO> {

    // 继承 BaseMapper 后自动获得基础方法：
    // - insert(T entity)
    // - deleteById(Serializable id)
    // - updateById(T entity)
    // - selectById(Serializable id)
    // - selectList(Wrapper<T> wrapper)
    // - selectPage(Page<T> page, Wrapper<T> wrapper)

    // 自定义查询方法
    ProductsVO getProductByDrugCode(@Param("drugCode") String drugCode);

    Integer createProduct(
        @Param("req") ProductDTO req,
        @Param("createBy") Long createBy,
        @Param("createDate") LocalDateTime createDate
    );

    // 分页查询
    Page<ProductsVO> pageProducts(
        Page<ProductsVO> page,
        @Param("req") ProductDTO req
    );
}
```

### 3.2 对象设计

#### DO、DTO、VO 的区别

**1. DO（Data Object）- 数据库实体**

```java
@Data
@TableName("bidding_product")
public class BiddingProductDO {
    @TableId(type = IdType.AUTO)
    private Long id;                    // 主键
    private String drugCode;            // 医保药品代码
    private String productName;         // 商品名
    private String commonName;          // 通用名
    private LocalDateTime createDate;   // 创建时间
    private LocalDateTime modifyDate;   // 修改时间
    private Integer deleted;            // 删除标识

    // 所有数据库字段
}
```

**2. DTO（Data Transfer Object）- 数据传输对象**

```java
@Data
public class ProductDTO {
    @NotNull(message = "医保药品代码不能为空")
    private String drugCode;

    @NotNull(message = "商品名不能为空")
    private String productName;

    private String commonName;
    private String potionType;
    private String specification;

    // 只包含前端传递的字段
    // 不包含 id、createDate 等数据库字段
}
```

**3. VO（View Object）- 视图对象**

```java
@Data
public class ProductsVO {
    // 基础字段
    private Long id;
    private String drugCode;
    private String productName;
    private String commonName;

    // 显示字段
    private String productStatus;      // 状态代码
    private String productStatusValue; // 状态名称

    // 扩展字段（来自其他表）
    private BigDecimal allLowestNettingPrice;  // 全国最低价
    private String allLowestPriceProvince;     // 最低价省份
}
```

**对象转换**：

```java
// DTO → DO（创建/更新）
public String createProduct(ProductDTO dto, AuthUserInfo userInfo) {
    BiddingProductDO productDO = new BiddingProductDO();

    // 方式1：手动设置
    productDO.setDrugCode(dto.getDrugCode());
    productDO.setProductName(dto.getProductName());

    // 方式2：使用 BeanUtils.copyProperties
    BeanUtils.copyProperties(dto, productDO, "id", "createDate");
    productDO.setCreateDate(LocalDateTime.now());
    productDO.setCreateBy(userInfo.getUserId());

    // 保存到数据库
    biddingProductMapper.insert(productDO);

    return "创建成功";
}

// DO → VO（查询）
public ProductsVO getProductDetail(String drugCode) {
    // 1. 查询 DO
    BiddingProductDO productDO = biddingProductMapper.selectOne(
        new LambdaQueryWrapper<BiddingProductDO>()
            .eq(BiddingProductDO::getDrugCode, drugCode)
    );

    // 2. 转换为 VO
    ProductsVO productVO = new ProductsVO();
    BeanUtils.copyProperties(productDO, productVO);

    // 3. 填充扩展字段
    productVO.setProductStatusValue(
        ProductStatusEnum.getDcrTypeEnum(productDO.getProductStatus()).getName()
    );

    // 4. 查询关联数据
    BigDecimal lowestPrice = biddingPriceMapper.getLowestPrice(drugCode);
    productVO.setAllLowestNettingPrice(lowestPrice);

    return productVO;
}
```

### 3.3 统一响应格式

**Result 类**：
```java
@Data
public class Result<T> {

    private String code;
    private String message;
    private T data;

    public static <T> Result<T> success() {
        return success(null);
    }

    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode("200");
        result.setMessage("success");
        result.setData(data);
        return result;
    }

    public static <T> Result<T> error(String code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        result.setData(null);
        return result;
    }

    public static <T> Result<T> error(ResultCode resultCode) {
        return error(resultCode.getCode(), resultCode.getMessage());
    }
}
```

**使用示例**：
```java
// 成功响应
return Result.success("操作成功");
return Result.success(productData);

// 错误响应
return Result.error("400", "参数错误");
return Result.error(ResultCode.INTERNAL_SERVER_ERROR);
```

### 3.4 全局异常处理

```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * 业务异常
     */
    @ExceptionHandler(BusinessException.class)
    @ResponseStatus(HttpStatus.OK)
    public Result<?> handleBusinessException(BusinessException e) {
        log.error("业务异常: {}", e.getMessage(), e);
        return Result.error(e.getCode(), e.getMessage());
    }

    /**
     * 参数校验异常
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public Result<?> handleMethodArgumentNotValidException(
        MethodArgumentNotValidException e) {

        String message = e.getBindingResult().getFieldErrors().stream()
            .map(FieldError::getDefaultMessage)
            .collect(Collectors.joining(", "));

        log.error("参数校验异常: {}", message);
        return Result.error(ResultCode.PARAM_ERROR.getCode(), message);
    }

    /**
     * 其他异常
     */
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public Result<?> handleException(Exception e) {
        log.error("系统异常: ", e);
        return Result.error(ResultCode.INTERNAL_SERVER_ERROR);
    }
}
```

---

## 四、核心业务实现

### 4.1 项目管理模块

#### 业务流程

```
创建项目
  ↓
填写项目信息
  ↓
添加产品列表
  ↓
上传资料文档
  ↓
保存草稿/提交审核
  ↓
审批流程
  ↓
项目结项
```

#### 项目保存

```java
@Service
public class BiddingProjectsServiceImpl {

    @Transactional(rollbackFor = Exception.class)
    public String save(AuthUserInfo userInfo, AddBiddingProjectsDTO dto) {
        // 1. 构建项目 DO
        BiddingProjectsDO projectDO = AddBiddingProjectsDTO.buildBiddingProjectsDO(dto, userInfo);

        // 2. 保存项目基础信息
        if (dto.getId() == null) {
            // 新增
            biddingProjectsMapper.insert(projectDO);
        } else {
            // 更新
            biddingProjectsMapper.updateById(projectDO);
        }

        // 3. 处理项目申请信息
        BiddingProjectApplyDO applyDO = new BiddingProjectApplyDO();
        applyDO.setProjectId(projectDO.getId());
        applyDO.setProjectCode(projectDO.getProjectCode());
        applyDO.setApplyType(dto.getBiddingProjectApplyDTO().getApplyType());
        applyDO.setApplyStatus(ApplyStatusEnum.APPLY_STATUS_1.getCode());
        applyDO.setApplyCode(generateCodeService.generateCode(PrefixEnum.APPLY));
        biddingProjectApplyMapper.insert(applyDO);

        // 4. 保存产品列表
        if (dto.getBiddingProjectProductDTOList() != null) {
            for (BiddingProjectProductDTO productDTO : dto.getBiddingProjectProductDTOList()) {
                BiddingProjectProductDO productDO = new BiddingProjectProductDO();
                BeanUtils.copyProperties(productDTO, productDO);
                productDO.setProjectId(projectDO.getId());
                productDO.setApplyCode(applyDO.getApplyCode());
                biddingProjectProductMapper.insert(productDO);
            }
        }

        // 5. 保存资料文档
        if (dto.getBiddingProjectDocumentDTOList() != null) {
            for (BiddingProjectDocumentDTO documentDTO : dto.getBiddingProjectDocumentDTOList()) {
                BiddingProjectDocumentDO documentDO = new BiddingProjectDocumentDO();
                BeanUtils.copyProperties(documentDTO, documentDO);
                documentDO.setProjectId(projectDO.getId());
                documentDO.setApplyCode(applyDO.getApplyCode());
                biddingProjectDocumentMapper.insert(documentDO);
            }
        }

        return "保存成功";
    }
}
```

#### 项目提交审核

```java
@Transactional(rollbackFor = Exception.class)
public String submitProject(AuthUserInfo userInfo, AddBiddingProjectsDTO dto) {
    // 1. 先保存项目
    save(userInfo, dto);

    // 2. 更新申请状态为审批中
    BiddingProjectApplyDO applyDO = biddingProjectApplyMapper.selectOne(
        new LambdaQueryWrapper<BiddingProjectApplyDO>()
            .eq(BiddingProjectApplyDO::getProjectCode, dto.getProjectCode())
    );
    applyDO.setApplyStatus(ApplyStatusEnum.APPLY_STATUS_2.getCode()); // 审批中
    biddingProjectApplyMapper.updateById(applyDO);

    // 3. 启动审批流程
    BiddingProcessDefinitionVO processVO = new BiddingProcessDefinitionVO();
    processVO.setProjectId(applyDO.getProjectId());
    processVO.setApplyId(applyDO.getId());
    processVO.setProcessKind(dto.getBiddingProjectApplyDTO().getApplyType());
    processVO.setCurrentUserId(userInfo.getUserId());

    processDefinitionService.startProcess(processVO);

    // 4. 生成待办任务
    // ...

    return "提交成功";
}
```

### 4.2 产品管理模块

#### 产品创建

```java
@Service
public class BiddingProductServiceImpl {

    @Override
    @OperationLog(
        beforeMethod = "snapshotBeforeSave(#req?.drugCode)",
        afterMethod = "snapshotAfterSave(#req?.drugCode)",
        userId = "#userInfo?.userId"
    )
    public String createProduct(ProductDTO req, AuthUserInfo userInfo) {
        // 1. 校验产品是否已存在
        ProductsVO existProduct = biddingProductMapper.getProductByDrugCode(
            req.getDrugCode()
        );
        if (existProduct != null) {
            throw new BusinessException("产品库中存在当前医保产品代码的产品");
        }

        // 2. 校验必填字段
        if (StringUtils.isBlank(req.getDrugCode())) {
            throw new BusinessException("新建产品医保药品代码不能为空");
        }

        // 3. 插入数据库
        LocalDateTime createDate = LocalDateTime.now();
        Integer affectedRow = biddingProductMapper.createProduct(
            req, userInfo.getUserId(), createDate
        );

        return affectedRow == 1 ? "新增产品成功" : "新增产品失败";
    }
}
```

#### 产品更新（带邮件通知）

```java
@Override
@OperationLog(
    beforeMethod = "snapshotBeforeSave(#req?.drugCode)",
    afterMethod = "snapshotAfterSave(#req?.drugCode)",
    userId = "#userInfo?.userId"
)
public String updateProductByDrugCode(ProductDTO req, AuthUserInfo userInfo) {
    // 1. 获取历史数据用于对比
    List<ChangeContentMailDTO> changeList = getEditProductItems(req);

    // 2. 更新产品
    LocalDateTime modifyDate = LocalDateTime.now();
    if (StringUtils.isBlank(req.getComment())) {
        throw new BusinessException("修改产品时comment不能为空");
    }

    Integer affectedRow = biddingProductMapper.updateProductByDrugCode(
        req, userInfo.getUserId(), modifyDate
    );

    // 3. 发送修改通知邮件
    Map<String, List<?>> userInfoMap = extractUserIdsAndEmails();
    List<String> emailList = (List<String>) userInfoMap.get("emailList");
    List<Long> idList = (List<Long>) userInfoMap.get("idList");

    // 获取抄送列表（角色 R4-准入负责人）
    List<UserVO> ccUsers = sysUserService.getUserInfoByRoleCode(
        AuthRoleCodeEnum.ROLE_TYPE_R4.getCode()
    );
    List<String> ccEmailList = ccUsers.stream()
        .map(UserVO::getEmail)
        .filter(StringUtils::isNotBlank)
        .toList();

    // 构建邮件内容
    NotificationEmailTemplateDTO emailDTO = new NotificationEmailTemplateDTO();
    emailDTO.setToEmailList(emailList);
    emailDTO.setCcEmailList(ccEmailList);
    emailDTO.setSenderId(userInfo.getUserId());
    emailDTO.setReceiveUserIds(idList);
    emailDTO.setCreateUserName(userInfo.getNickname());
    emailDTO.setCreateTime(LocalDateTime.now());
    emailDTO.setUpdateUserName(userInfo.getNickname());
    emailDTO.setUpdateTime(LocalDateTime.now());
    emailDTO.setUpdateContentList(changeList);
    emailDTO.setRemark(req.getComment());

    notificationEmailService.sendProductRevisedEmail(emailDTO);

    return affectedRow == 1 ? "修改产品成功" : "修改产品失败";
}
```

### 4.3 价格管理模块

#### 价格创建

```java
@Service
public class BiddingPriceServiceImpl {

    @Transactional(rollbackFor = Exception.class)
    @Override
    public String createPrice(PriceDTO req, AuthUserInfo userInfo) {
        // 1. 参数校验
        if (StringUtils.isBlank(req.getProvince())) {
            throw new BusinessException("新建价格省份不能为空");
        }
        if (StringUtils.isBlank(req.getPriceType())) {
            throw new BusinessException("新建价格价格类别不能为空");
        }
        if (CollectionUtils.isEmpty(req.getPriceProductList())) {
            throw new BusinessException("新建价格产品信息不能为空");
        }

        // 2. 批量插入价格
        for (PriceDTO.priceProduct priceProduct : req.getPriceProductList()) {
            // 2.1 检查是否有执行中的价格
            Integer resultNum = biddingPriceMapper.checkPriceExist(
                req.getProvince(),
                null,
                priceProduct.getProductDrugKey()
            );
            if (resultNum != 0) {
                throw new BusinessException(
                    "已存在当前省份、医保药品代码，挂网状态为执行中的价格信息"
                );
            }

            // 2.2 检查执行时间是否在上一个已完结价格之后
            BiddingPriceDO latestFinishedPrice = biddingPriceMapper.getLatestFinishedPrice(
                req.getProvince(),
                priceProduct.getProductDrugKey()
            );

            if (latestFinishedPrice != null && priceProduct.getExecutionPriceDate() != null) {
                LocalDateTime newExecutionDate = LocalDateTime.parse(
                    priceProduct.getExecutionPriceDate(),
                    DateTimeFormatter.ISO_DATE_TIME
                );

                if (latestFinishedPrice.getPriceEndDate() != null) {
                    if (!newExecutionDate.isAfter(latestFinishedPrice.getPriceEndDate())) {
                        throw new BusinessException(
                            "价格执行时间必须在上一个已完结的价格结束时间之后"
                        );
                    }
                }
            }

            // 2.3 插入价格数据
            LocalDateTime createDate = LocalDateTime.now();
            Integer result = biddingPriceMapper.createPrice(
                req.getProvince(),
                req.getPriceType(),
                req.getCity(),
                req.getProjectType(),
                req.getNettingStatus(),
                req.getRedYellowLabel(),
                req.getDirectoryType(),
                req.getCollectionMark(),
                req.getProjectYear(),
                req.getProjectName(),
                priceProduct.getNettingPrice(),
                priceProduct.getReferencePrice(),
                priceProduct.getTransactionPrice(),
                priceProduct.getExecutionPriceDate() != null ?
                    LocalDateTime.parse(priceProduct.getExecutionPriceDate()) : null,
                priceProduct.getPriceEndDate() != null ?
                    LocalDateTime.parse(priceProduct.getPriceEndDate()) : null,
                priceProduct.getExecutionStatus(),
                priceProduct.getPriceSupport(),
                req.getComment(),
                priceProduct.getProductDrugKey(),
                userInfo.getUserId(),
                createDate,
                req.getProjectCode()
            );

            if (result == null || result == 0) {
                throw new BusinessException("插入报价失败");
            }
        }

        // 3. 发送邮件通知招采经理
        // ...

        return "创建成功";
    }
}
```

### 4.4 资料管理模块

#### 产品资料创建

```java
@Service
public class BiddingMaterialServiceImpl {

    @Transactional
    @Override
    public String materialProductAdd(AuthUserInfo userInfo, MasterMaterialProductAddDTO req) {
        // 1. 校验资料类型
        HashMap<String, String> sysDictMap = sysDictService.getSysDictMap(
            MasterMaterialCategoryEnum.CATEGORY_01.getCode()
        );
        String dictLabel = sysDictMap.get(req.getDocumentType());
        if (StringUtils.isBlank(dictLabel)) {
            throw new BusinessException("资料类型不合法");
        }

        // 2. 获取默认过期时间配置
        HashMap<String, String> sysDictPositiveMap = sysDictService.getSysDictPositiveMap(
            SysDictTypeEnum.COMMON_CONFIG.getCode()
        );
        String meansExpiredTime = sysDictPositiveMap.get("MEANS_EXPIRED_TIME");
        if (StringUtils.isBlank(meansExpiredTime)) {
            meansExpiredTime = "30";  // 默认30天
        }

        // 3. 获取产品信息
        ProductsVO productInfo = biddingProductMapper.getProductByDrugCode(req.getDrugCode());
        if (productInfo == null) {
            throw new BusinessException("产品信息不存在");
        }

        // 4. 获取文件信息
        LambdaQueryWrapper<BiddingFileInfoDO> param = new LambdaQueryWrapper<BiddingFileInfoDO>()
            .eq(BiddingFileInfoDO::getFileNumber, req.getFileNumber());
        BiddingFileInfoDO fileInfo = biddingFileInfoMapper.selectOne(param);
        if (fileInfo == null) {
            throw new BusinessException("上传的文件信息不存在");
        }

        // 5. 校验当前库的数据
        BiddingMaterialDO existMaterial = biddingMaterialMapper.getMaterialInfoByProductDruCode(
            req.getDrugCode(),
            req.getDocumentType(),
            MasterMaterialCategoryEnum.CATEGORY_01.getCode(),
            req.getNoteNaming()
        );
        if (existMaterial != null) {
            throw new BusinessException("当前产品编码+类型+备注名，查询资料库已存在数据");
        }

        // 6. 生成资料编号
        String documentNumber = generateCodeService.generateCode(PrefixEnum.MATERIAL_01);

        // 7. 生成资料名称
        String documentName = Stream.of(
                productInfo.getProductName(),
                productInfo.getPotionType(),
                productInfo.getSpecification(),
                dictLabel,
                req.getNoteNaming()
            )
            .filter(StringUtils::isNotBlank)
            .map(String::trim)
            .collect(Collectors.joining("_"));

        // 8. 更新文件重命名
        fileInfo.setRenames(documentName);
        biddingFileInfoMapper.updateById(fileInfo);

        // 9. 构建资料 DO
        BiddingMaterialDO materialDO = BeanUtil.a2b(req, BiddingMaterialDO.class);
        materialDO.setDocumentName(documentName);
        materialDO.setDocumentNumber(documentNumber);
        materialDO.setCreateBy(userInfo.getUserId());
        materialDO.setModifyBy(userInfo.getUserId());
        materialDO.setCreateDate(LocalDateTime.now());
        materialDO.setModifyDate(LocalDateTime.now());
        materialDO.setDeleted(false);
        materialDO.setDocumentCategory(MasterMaterialCategoryEnum.CATEGORY_01.getCode());
        materialDO.setDocumentStatus(MasterMaterialStatusEnum.MATERIAL_STATUS_01.getCode());

        // 10. 计算资料状态
        LocalDateTime localDateTime = DateUtil.getDayStartDate(new Date(), 0);
        LocalDateTime now = LocalDateTime.now();
        req.setValidStartDate(DateUtil.getDayStart(req.getValidStartDate(), 0));
        req.setValidEndDate(DateUtil.getDayStart(req.getValidEndDate(), 0));

        if (MasterMaterialStatusEnum.MATERIAL_STATUS_04.getCode().equals(req.getDocumentStatus())) {
            materialDO.setDocumentStatus(MasterMaterialStatusEnum.MATERIAL_STATUS_04.getCode());
        } else {
            if (localDateTime.isAfter(req.getValidEndDate())) {
                materialDO.setDocumentStatus(MasterMaterialStatusEnum.MATERIAL_STATUS_02.getCode());
            } else if (DateUtil.getDayStart(localDateTime, Integer.parseInt(meansExpiredTime))
                .isAfter(req.getValidEndDate())) {
                materialDO.setDocumentStatus(MasterMaterialStatusEnum.MATERIAL_STATUS_03.getCode());
            }
        }

        if (!req.getValidStartDate().isBefore(req.getValidEndDate())) {
            throw new BusinessException("开始时间要小于结束时间");
        }

        materialDO.setValidStartDate(req.getValidStartDate());
        materialDO.setValidEndDate(req.getValidEndDate());

        // 11. 插入资料
        biddingMaterialMapper.insert(materialDO);

        // 12. 插入资料产品关联
        BiddingMaterialProductDO materialProductDO = new BiddingMaterialProductDO();
        materialProductDO.setCreateBy(userInfo.getUserId());
        materialProductDO.setModifyBy(userInfo.getUserId());
        materialProductDO.setCreateDate(now);
        materialProductDO.setModifyDate(now);
        materialProductDO.setDocumentNumber(documentNumber);
        materialProductDO.setDrugCode(req.getDrugCode());
        materialProductDO.setDeleted(false);
        biddingMaterialProductMapper.insert(materialProductDO);

        return documentNumber;
    }
}
```

### 4.5 待办管理模块

#### 待办生成

```java
@Service
public class BiddingTodoServiceImpl {

    @Override
    public void generateTodoForApprovalNode(
        BiddingProcessDefinitionVO definition,
        BiddingProcessNodeVO node,
        BiddingProjectApplyVO applyVO) {

        // 1. 清除该项目之前的待办
        clearTodoByProjectApplyId(definition, applyVO);

        // 2. 创建新待办
        BiddingTodoDO todo = createDefaultTodo(definition, node, applyVO);
        biddingTodoMapper.insert(todo);
    }

    private BiddingTodoDO createDefaultTodo(
        BiddingProcessDefinitionVO definition,
        BiddingProcessNodeVO node,
        BiddingProjectApplyVO applyVO) {

        BiddingTodoDO todo = new BiddingTodoDO();
        Long userId = definition.getCurrentUserId();

        // 根据角色类型设置待办处理人
        if (AuthRoleCodeEnum.ROLE_TYPE_R1.getCode().equals(node.getResponsibleRole())) {
            // R1 角色 - 按地区分配
            BiddingProjectsDO project = projectsMapper.selectById(definition.getProjectId());
            List<String> regionList = Arrays.stream(project.getInvolvedRegions().split(",")).toList();

            List<BiddingSysRoleRegionVO> roleCodeList = regionMapper.getRegionByRoleCodeList(
                AuthRoleCodeEnum.ROLE_TYPE_R1.getCode(),
                regionList
            );

            todo.setProjectCode(applyVO.getProjectCode())
                .setTodoCode(generateCodeService.generateCode(PrefixEnum.TODO))
                .setBusinessScenario(applyVO.getApplyType())
                .setBusinessCode(applyVO.getApplyType())
                .setTodoOperationType(Constant.TODOUSERTYPE_USER)
                .setTodoOperationId(roleCodeList.get(0).getUserId())
                .setTodoType(determineTodoType(node))
                .setTodoName(generateTodoName(definition, node))
                .setApplyCode(applyVO.getApplyCode())
                .setInProcess(true);
        } else {
            // 其他角色 - 按角色分配
            LambdaQueryWrapper<BiddingSysRoleDO> roleQuery = new LambdaQueryWrapper<BiddingSysRoleDO>()
                .eq(BiddingSysRoleDO::getDeleted, false)
                .eq(BiddingSysRoleDO::getRoleCode, node.getResponsibleRole());
            BiddingSysRoleDO roleDO = roleMapper.selectOne(roleQuery);

            todo.setProjectCode(applyVO.getProjectCode())
                .setTodoCode(generateCodeService.generateCode(PrefixEnum.TODO))
                .setBusinessScenario(applyVO.getApplyType())
                .setBusinessCode(applyVO.getApplyType())
                .setTodoOperationType(Constant.TODOUSERTYPE_ROLE)
                .setTodoOperationId(roleDO.getId())
                .setTodoType(determineTodoType(node))
                .setTodoName(generateTodoName(definition, node))
                .setApplyCode(applyVO.getApplyCode())
                .setInProcess(true);
        }

        // 设置状态和时间
        todo.setTodoStatus("1")  // 1-待开始
            .setCreateBy(userId)
            .setCreateTime(LocalDateTime.now())
            .setUpdateBy(userId)
            .setUpdateTime(LocalDateTime.now())
            .setDeleted(false)
            .setOperatorId(userId);

        return todo;
    }
}
```

---

## 五、技术实现细节

### 5.1 AOP 操作日志

**为什么使用 AOP？**

✅ **解耦**：将日志记录逻辑从业务代码中分离
✅ **复用**：一个切面可以处理所有需要记录日志的方法
✅ **统一**：统一的日志格式和记录方式
✅ **灵活**：通过注解控制哪些方法需要记录日志

**自定义注解**：
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface OperationLog {
    String beforeMethod() default "";
    String afterMethod() default "";
    String userId() default "";
}
```

**AOP 切面**：
```java
@Aspect
@Component
public class OperationLogAspect {

    @Around("@annotation(com.bayer.bidding.annotation.OperationLog)")
    public Object around(ProceedingJoinPoint pjp) throws Throwable {
        MethodSignature ms = (MethodSignature) pjp.getSignature();
        Method method = ms.getMethod();
        OperationLog op = method.getAnnotation(OperationLog.class);

        // 1. 准备 SpEL 上下文变量
        String[] paramNames = ms.getParameterNames();
        Object[] args = pjp.getArgs();
        Map<String, Object> vars = new HashMap<>();
        if (paramNames != null) {
            for (int i = 0; i < paramNames.length; i++) {
                vars.put(paramNames[i], args[i]);
            }
        }

        // 2. 执行 before 方法获取操作前快照
        Object before = resolveBefore(op, pjp, vars);

        // 3. 执行业务方法
        Object result = pjp.proceed();

        // 4. 执行 after 方法获取操作后快照
        Object after = resolveAfter(op, pjp, vars, result);

        // 5. 计算差异
        Map<String, Object> mapBefore = toMapSafe(before);
        Map<String, Object> mapAfter = toMapSafe(after);

        String diffJson;
        try {
            diffJson = ObjectDiffUtil.diffAsJson(mapBefore, mapAfter);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("操作内容前后比较出错", e);
        }

        // 6. 记录日志
        BiddingOperationLogDO logDO = new BiddingOperationLogDO();
        logDO.setOperationLog(diffJson);
        logDO.setCreateBy(Long.valueOf(extractUserId(op.userId(), vars, pjp.getTarget())));
        logDO.setCreateTime(LocalDateTime.now());

        // 在事务提交后写日志
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    biddingOperationLogService.recordOperation(logDO);
                }
            }
        );

        return result;
    }
}
```

**使用示例**：
```java
@Service
public class BiddingProductServiceImpl {

    @OperationLog(
        beforeMethod = "snapshotBeforeSave(#req?.drugCode)",
        afterMethod = "snapshotAfterSave(#req?.drugCode)",
        userId = "#userInfo?.userId"
    )
    public String updateProductByDrugCode(ProductDTO req, AuthUserInfo userInfo) {
        // 业务逻辑
        biddingProductMapper.updateById(productDO);
        return "修改产品成功";
    }

    // 操作前快照
    public Map<String, Object> snapshotBeforeSave(String drugCode) {
        Map<String, Object> snap = new HashMap<>();
        try {
            if (drugCode != null) {
                LambdaQueryWrapper<BiddingProductDO> param = new LambdaQueryWrapper<BiddingProductDO>()
                    .eq(BiddingProductDO::getDrugCode, drugCode);
                snap.put("bidding_product", biddingProductMapper.selectList(param));
            }
        } catch (Exception ex) {
            log.info("操作日志记录异常: ", ex);
        }
        return snap;
    }

    // 操作后快照
    public Map<String, Object> snapshotAfterSave(String drugCode) {
        Map<String, Object> snap = new HashMap<>();
        try {
            if (drugCode != null) {
                LambdaQueryWrapper<BiddingProductDO> param = new LambdaQueryWrapper<BiddingProductDO>()
                    .eq(BiddingProductDO::getDrugCode, drugCode);
                snap.put("bidding_product", biddingProductMapper.selectList(param));
            }
        } catch (Exception ex) {
            log.info("操作日志记录异常: ", ex);
        }
        return snap;
    }
}
```

### 5.2 异步任务

**线程池配置**：
```java
@Configuration
public class ThreadPoolConfig {

    @Value("${threadpool.core_size}")
    private int corePoolSize;

    @Value("${threadpool.max_size}")
    private int maxPoolSize;

    @Value("${threadpool.queue_capacity}")
    private int queueCapacity;

    @Bean
    public ThreadPoolTaskExecutor asyncServiceExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(corePoolSize);      // 核心线程数: 64
        executor.setMaxPoolSize(maxPoolSize);         // 最大线程数: 2048
        executor.setQueueCapacity(queueCapacity);     // 队列容量: 2048
        executor.setThreadNamePrefix("async-service-");
        executor.setKeepAliveSeconds(300);            // 空闲线程存活时间: 300秒
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.AbortPolicy());
        executor.initialize();
        return executor;
    }
}
```

**使用 @Async**：
```java
@Service
public class EmailNotificationServiceImpl {

    @Async("asyncServiceExecutor")
    public void sendEmailAsync(
        List<String> toEmails,
        String subject,
        String content) {

        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true);

            helper.setTo(toEmails.toArray(new String[0]));
            helper.setSubject(subject);
            helper.setText(content, true);

            mailSender.send(message);

            log.info("邮件发送成功: {}", toEmails);
        } catch (Exception e) {
            log.error("邮件发送失败: {}", toEmails, e);
        }
    }
}
```

### 5.3 定时任务

**定时任务配置**：
```yaml
task:
  schedule:
    sendMailDay: "0 0 9 * * ?"      # 每天9点发送邮件
    checkMaterialDay: "0 0 9 * * ?" # 每天9点检查资料
```

**定时任务实现**：
```java
@Component
@Slf4j
public class ScheduledTasks {

    @Autowired
    private BiddingMaterialService materialService;

    /**
     * 每天9点检查资料有效期并发送提醒邮件
     */
    @Scheduled(cron = "${task.schedule.checkMaterialDay}")
    public void checkMaterialExpiration() {
        log.info("开始检查资料有效期");

        try {
            String[] days = expiredDays.split(",");

            for (String day : days) {
                int daysBefore = Integer.parseInt(day.trim());

                // 1. 查询即将过期的资料
                LocalDateTime expirationDate = LocalDateTime.now().plusDays(daysBefore);
                List<BiddingMaterialDO> materials = materialService
                    .getMaterialsExpiringBefore(expirationDate);

                if (materials.isEmpty()) {
                    continue;
                }

                // 2. 发送提醒邮件
                for (BiddingMaterialDO material : materials) {
                    sendExpirationReminderEmail(material, daysBefore);
                }

                log.info("检查资料有效期完成, 天数: {}, 数量: {}", daysBefore, materials.size());
            }
        } catch (Exception e) {
            log.error("检查资料有效期失败", e);
        }
    }
}
```

---

## 六、数据库设计

### 6.1 核心表设计

**项目表（bidding_projects）**：
```sql
CREATE TABLE `bidding_projects` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
    `project_code` varchar(100) NOT NULL COMMENT '项目编号',
    `project_name` varchar(100) NOT NULL COMMENT '项目名称',
    `project_category` varchar(2) NOT NULL COMMENT '项目类别',
    `project_type` varchar(2) NOT NULL COMMENT '项目类型',
    `parent_project_id` bigint(20) DEFAULT NULL COMMENT '父项目ID',
    `applicant_user_id` bigint(20) NOT NULL COMMENT '申请人ID',
    `involved_regions` varchar(500) DEFAULT NULL COMMENT '参与省份',
    `project_status` varchar(2) NOT NULL COMMENT '项目状态',
    `create_by` bigint(100) DEFAULT NULL COMMENT '创建者',
    `create_time` datetime DEFAULT NULL COMMENT '创建时间',
    `update_by` bigint(100) DEFAULT NULL COMMENT '更新者',
    `update_time` datetime DEFAULT NULL COMMENT '更新时间',
    `deleted` tinyint(1) DEFAULT '0' COMMENT '删除标识',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_project_code` (`project_code`),
    KEY `idx_parent_project_id` (`parent_project_id`),
    KEY `idx_project_status` (`project_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='项目表';
```

**产品表（bidding_product）**：
```sql
CREATE TABLE `bidding_product` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
    `drug_code` varchar(100) DEFAULT NULL COMMENT '医保药品代码',
    `approval_number` varchar(100) DEFAULT NULL COMMENT '批准文号',
    `product_name` varchar(100) DEFAULT NULL COMMENT '商品名',
    `common_name` varchar(100) DEFAULT NULL COMMENT '通用名',
    `potion_type` varchar(100) DEFAULT NULL COMMENT '剂型',
    `specification` varchar(100) DEFAULT NULL COMMENT '规格',
    `product_status` varchar(100) DEFAULT NULL COMMENT '产品状态',
    `deleted` tinyint(1) DEFAULT '0' COMMENT '删除标志',
    `create_by` bigint(100) DEFAULT NULL COMMENT '创建者',
    `create_date` datetime DEFAULT NULL COMMENT '创建时间',
    `modify_by` bigint(100) DEFAULT NULL COMMENT '修改者',
    `modify_date` datetime DEFAULT NULL COMMENT '修改时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_drug_code` (`drug_code`),
    KEY `idx_product_status` (`product_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='产品库';
```

**价格表（bidding_price）**：
```sql
CREATE TABLE `bidding_price` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
    `province` varchar(100) DEFAULT NULL COMMENT '省份',
    `city` varchar(100) DEFAULT NULL COMMENT '城市',
    `price_type` varchar(100) DEFAULT NULL COMMENT '价格类别',
    `netting_status` varchar(100) DEFAULT NULL COMMENT '挂网状态',
    `netting_price` decimal(10,2) DEFAULT NULL COMMENT '挂网价',
    `transaction_price` decimal(10,2) DEFAULT NULL COMMENT '交易价格',
    `execution_price_date` datetime DEFAULT NULL COMMENT '执行时间',
    `price_end_date` datetime DEFAULT NULL COMMENT '结束时间',
    `product_drug_key` varchar(100) DEFAULT NULL COMMENT '产品医保代码',
    `deleted` tinyint(1) DEFAULT '0' COMMENT '删除标志',
    `create_by` bigint(100) DEFAULT NULL COMMENT '创建者',
    `create_date` datetime DEFAULT NULL COMMENT '创建时间',
    `modify_by` bigint(100) DEFAULT NULL COMMENT '修改者',
    `modify_date` datetime DEFAULT NULL COMMENT '修改时间',
    PRIMARY KEY (`id`),
    KEY `idx_product_drug_key` (`product_drug_key`),
    KEY `idx_province_city` (`province`, `city`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='价格库';
```

### 6.2 表关联关系

```
bidding_projects (项目表)
    ├── 1:N → bidding_project_apply (项目申请表)
    │         └── 1:1 → bidding_process_definition (流程定义表)
    │                   └── 1:N → bidding_process_node (流程节点表)
    │
    ├── 1:N → bidding_project_product (项目产品表)
    │         └── N:1 → bidding_product (产品表)
    │
    └── 1:N → bidding_project_document (项目资料表)
              └── N:1 → bidding_material (资料表)

bidding_todo (待办表)
    ├── N:1 → bidding_projects (项目表)
    └── N:1 → bidding_process_definition (流程定义表)

bidding_operation_log (操作日志表)
    ├── N:1 → bidding_projects (项目表)
    ├── N:1 → bidding_product (产品表)
    └── N:1 → bidding_price (价格表)
```

---

## 七、开发规范与最佳实践

### 7.1 命名规范

**包命名**：
```
com.bayer.bidding
├── controller      # 控制器层
├── service         # 服务层
│   └── impl        # 服务实现
├── mapper          # 数据访问层
├── entity          # 实体类（DO）
├── bean
│   ├── dto         # 数据传输对象
│   └── vo          # 视图对象
├── config          # 配置类
├── util            # 工具类
└── enums           # 枚举类
```

**类命名**：
- Controller：`XxxController`
- Service：`IXxxService`（接口）、`XxxServiceImpl`（实现）
- Mapper：`XxxMapper`
- Entity（DO）：`XxxDO`
- DTO：`XxxDTO`
- VO：`XxxVO`
- Enum：`XxxEnum`

**方法命名**：
```java
// 查询
getXxxById(Long id)
listXxxByXxx(Object param)
pageXxx(Page page, Object param)

// 新增
createXxx(XxxDTO dto)
addXxx(XxxDTO dto)
saveXxx(XxxDTO dto)

// 更新
updateXxx(XxxDTO dto)
modifyXxx(XxxDTO dto)

// 删除
deleteXxxById(Long id)
removeXxxById(Long id)

// 判断
checkXxx(Object param)
validateXxx(Object param)
```

### 7.2 注释规范

**类注释**：
```java
/**
 * 产品管理服务实现
 *
 * @author zhangsan
 * @since 2024-01-01
 */
@Service
public class BiddingProductServiceImpl implements IBiddingProductService {
    // ...
}
```

**方法注释**：
```java
/**
 * 创建产品
 *
 * @param req 产品信息
 * @param userInfo 当前用户信息
 * @return 操作结果
 */
public String createProduct(ProductDTO req, AuthUserInfo userInfo) {
    // ...
}
```

### 7.3 异常处理规范

**业务异常**：
```java
// 抛出业务异常
if (existProduct != null) {
    throw new BusinessException("产品库中存在当前医保产品代码");
}

// 带错误码的异常
throw new BusinessException("400", "参数错误");
```

**全局异常处理**：
```java
@ExceptionHandler(BusinessException.class)
public Result<?> handleBusinessException(BusinessException e) {
    log.error("业务异常: {}", e.getMessage());
    return Result.error(e.getCode(), e.getMessage());
}
```

### 7.4 日志规范

**日志级别**：
- ERROR：错误日志，系统异常
- WARN：警告日志，业务异常
- INFO：重要信息日志
- DEBUG：调试信息日志

**使用示例**：
```java
@Slf4j
@Service
public class BiddingProductServiceImpl {

    public String createProduct(ProductDTO req, AuthUserInfo userInfo) {
        log.info("开始创建产品, drugCode={}", req.getDrugCode());

        try {
            // 业务逻辑
            log.info("创建产品成功, drugCode={}", req.getDrugCode());
            return "成功";
        } catch (Exception e) {
            log.error("创建产品失败, drugCode={}", req.getDrugCode(), e);
            throw new BusinessException("创建产品失败");
        }
    }
}
```

---

## 八、常见问题与解决方案

### 8.1 开发问题

**Q1: MyBatis Plus 字段映射失败**

**A**: 检查字段命名是否匹配
```yaml
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true  # 驼峰命名转换
```

**Q2: 事务不生效**

**A**: 检查是否在同一个类中调用
```java
@Service
public class XxxServiceImpl {

    // ❌ 事务不生效（同类调用）
    public void method1() {
        method2();
    }

    @Transactional
    public void method2() {
        // ...
    }

    // ✅ 事务生效（注入自己）
    @Autowired
    private XxxService self;

    public void method1() {
        self.method2();
    }
}
```

**Q3: 异步方法不生效**

**A**: 检查是否在同一个类中调用
```java
@Service
public class XxxServiceImpl {

    // ❌ 异步不生效（同类调用）
    public void method1() {
        method2();
    }

    @Async
    public void method2() {
        // ...
    }

    // ✅ 异步生效（注入自己）
    @Autowired
    private XxxService self;

    public void method1() {
        self.method2();
    }
}
```

### 8.2 性能问题

**Q4: 查询慢**

**A**: 使用索引和分页
```sql
-- 添加索引
CREATE INDEX idx_drug_code ON bidding_product(drug_code);

-- 使用分页
SELECT * FROM bidding_product LIMIT 10 OFFSET 0;
```

**Q5: 内存溢出**

**A**: 使用分页查询
```java
// ❌ 一次查询所有数据
List<BiddingProductDO> list = biddingProductMapper.selectList(null);

// ✅ 分页查询
Page<BiddingProductDO> page = new Page<>(1, 1000);
Page<BiddingProductDO> result = biddingProductMapper.selectPage(page, null);
```

---

## 总结

本文档详细介绍了拜耳智能招采平台的后端技术实现，包括：

✅ Spring Boot 3 + Java 17 核心技术
✅ MyBatis Plus 数据访问
✅ Spring Security + JWT 安全认证
✅ 清晰的分层架构设计
✅ 完整的业务实现示例
✅ AOP 操作日志
✅ 异步任务和定时任务
✅ 开发规范和最佳实践

希望这份文档能帮助开发者快速理解项目架构和业务逻辑！
